from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from contextlib import asynccontextmanager
from app.routers import securities, market, history
import uvicorn

@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    
    - –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç—ã
    - –ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ: –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    """
    print("üöÄ MOEX Proxy API –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    yield
    print("üõë MOEX Proxy API –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...")

# –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –¥–ª—è Swagger
app = FastAPI(
    title="MOEX ISS Proxy API",
    description="""
    ## üì° –ü—Ä–æ–∫—Å–∏-API –∫ –ú–æ—Å–∫–æ–≤—Å–∫–æ–π –±–∏—Ä–∂–µ (MOEX ISS)
    
    –≠—Ç–æ—Ç API —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–æ–º –∫ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º—É API –ú–æ—Å–∫–æ–≤—Å–∫–æ–π –±–∏—Ä–∂–∏ (ISS).
    
    ### üîó –ß—Ç–æ —Ç–∞–∫–æ–µ MOEX ISS?
    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ-—Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä (ISS) ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ú–æ—Å–∫–æ–≤—Å–∫–æ–π –±–∏—Ä–∂–∏ 
    –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π ~15 –º–∏–Ω—É—Ç.
    
    ### ‚ö†Ô∏è –í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
    1. **–ó–∞–¥–µ—Ä–∂–∫–∞ –¥–∞–Ω–Ω—ã—Ö**: ~15 –º–∏–Ω—É—Ç –¥–ª—è —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    2. **–õ–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤**: ISS –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —á–∞—Å—Ç–æ—Ç–µ –∑–∞–ø—Ä–æ—Å–æ–≤
    3. **–¢–æ–ª—å–∫–æ –¥–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è**: –ù–µ –¥–ª—è —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π
    4. **–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ**: API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ, —á—Ç–æ –∏ ISS
    
    ### üìä –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è:
    - **–¢–æ—Ä–≥–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ (engine)**: `stock` (—Ñ–æ–Ω–¥–æ–≤—ã–π —Ä—ã–Ω–æ–∫), `currency` (–≤–∞–ª—é—Ç–Ω—ã–π), `futures` (—Å—Ä–æ—á–Ω—ã–π)
    - **–†—ã–Ω–æ–∫ (market)**: `shares` (–∞–∫—Ü–∏–∏), `bonds` (–æ–±–ª–∏–≥–∞—Ü–∏–∏), `index` (–∏–Ω–¥–µ–∫—Å—ã)
    - **–†–µ–∂–∏–º —Ç–æ—Ä–≥–æ–≤ (board)**: `TQBR` (–∞–∫—Ü–∏–∏ –¢+), `TQTF` (ETF), `TQTD` (–¥–µ–ø–æ–∑–∏—Ç–∞—Ä–Ω—ã–µ —Ä–∞—Å–ø–∏—Å–∫–∏)
    
    ### üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:
    1. –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—É–º–∞–≥–µ: `GET /securities/SBER`
    2. –ü–æ–ª—É—á–∏—Ç—å –∫–æ—Ç–∏—Ä–æ–≤–∫–∏: `GET /market/shares/TQBR/SBER`
    3. –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Å–≤–µ—á–∏: `GET /history/candles/SBER?interval=24&from=2024-01-01`
    """,
    version="1.0.0",
    contact={
        "name": "MOEX ISS Proxy API",
        "url": "https://www.moex.com/a2193",
    },
    license_info={
        "name": "MOEX ISS Terms of Use",
        "url": "https://www.moex.com/s116",
    },
    lifespan=lifespan,
    docs_url="/docs",  # Swagger UI
    redoc_url="/redoc",  # ReDoc –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
    openapi_tags=[
        {
            "name": "securities",
            "description": "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ü–µ–Ω–Ω—ã—Ö –±—É–º–∞–≥–∞—Ö (–∞–∫—Ü–∏–∏, –æ–±–ª–∏–≥–∞—Ü–∏–∏, ETF –∏ —Ç.–¥.)",
        },
        {
            "name": "market",
            "description": "–¢–µ–∫—É—â–∏–µ —Ä—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∫–æ—Ç–∏—Ä–æ–≤–∫–∏, —Å—Ç–∞–∫–∞–Ω—ã, —Å–¥–µ–ª–∫–∏)",
        },
        {
            "name": "history",
            "description": "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (—Å–≤–µ—á–∏, –∏—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤)",
        },
        {
            "name": "reference",
            "description": "–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (—Ç–æ—Ä–≥–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã, —Ä—ã–Ω–∫–∏, —Ä–µ–∂–∏–º—ã —Ç–æ—Ä–≥–æ–≤)",
        },
    ],
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # –í production –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã
app.include_router(securities.router)
app.include_router(market.router)
app.include_router(history.router)

# –ö–æ—Ä–Ω–µ–≤–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
@app.get("/", tags=["root"])
async def root():
    """
    –ö–æ—Ä–Ω–µ–≤–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç API.
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä–≤–∏—Å–µ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã.
    """
    return {
        "service": "MOEX ISS Proxy API",
        "description": "–ü—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –ú–æ—Å–∫–æ–≤—Å–∫–æ–π –±–∏—Ä–∂–∏",
        "version": "1.0.0",
        "documentation": {
            "swagger": "/docs",
            "redoc": "/redoc",
            "openapi": "/openapi.json"
        },
        "endpoints": {
            "securities": {
                "info": "GET /securities/{ticker} - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—É–º–∞–≥–µ",
                "search": "GET /securities?q={query} - –ü–æ–∏—Å–∫ –±—É–º–∞–≥",
                "indices": "GET /securities/{ticker}/indices - –ò–Ω–¥–µ–∫—Å—ã –±—É–º–∞–≥–∏",
            },
            "market": {
                "securities": "GET /market/{market}/{board} - –°–ø–∏—Å–æ–∫ –±—É–º–∞–≥ —Ä—ã–Ω–∫–∞",
                "quotes": "GET /market/{market}/{board}/{ticker} - –ö–æ—Ç–∏—Ä–æ–≤–∫–∏",
                "orderbook": "GET /market/{market}/{board}/{ticker}/orderbook - –°—Ç–∞–∫–∞–Ω",
                "trades": "GET /market/{market}/{board}/{ticker}/trades - –°–¥–µ–ª–∫–∏",
            },
            "history": {
                "candles": "GET /history/candles/{ticker} - –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Å–≤–µ—á–∏",
            }
        },
        "note": "–í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π ~15 –º–∏–Ω—É—Ç"
    }

# –≠–Ω–¥–ø–æ–∏–Ω—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è
@app.get("/health", tags=["monitoring"])
async def health_check():
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ API.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞.
    """
    return {
        "status": "healthy",
        "service": "moex-proxy-api",
        "timestamp": "2024-01-15T10:30:00Z"
    }

# –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
if __name__ == "__main__":
    uvicorn.run(
        "app.main:app",
        host="127.0.0.1",
        port=8000,
        reload=True,
        log_level="info"
    )